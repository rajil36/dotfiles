function PWCHANGER(){var e=2,n="",t=[],a="",o="",i="",r="",s="",u="",c=0,d=0,f="",p="",y=[],h=100100,_=10,g="",k=[],w=!1,m=!1,v=!1;function b(){return"undefined"!=typeof $?$.ajax:LPPlatform.doAjax}function T(e,t,a,o,i,r,s,u,c,d,l,h,g,k,w){var m=void 0!==g?g:"",v,b;void 0!==k&&k&&(_=k),void 0!==l&&null!=l||(l=""),"function"!=typeof s&&(s=function(){}),f=l,p=h,n=u,"function"==typeof c&&c(0,0),P(a,t,o,r,function(n){if("string"==typeof n)if("usernametaken"!=n){"function"==typeof c&&c(0,1);var r={oldkey:e,oldkey1:m,oldpwhash:t,oldemail:a,newemail:o,newpassword:i,callback:s,reencrypt:n,status:c,foundendmarker:!1};w&&(r.ks="true"),y=r,setTimeout(function(){R()},0)}else s(1,!1,!1,"B : Username Taken");else s(4,!1,!1,"A : Invalid Response")},function(e,n,t){s(2,!1,!1,"C : "+n+" suberror="+t)},d)}function P(e,t,a,o,i,r,s){var u=function(){var u=void 0!==t&&null!=t&&""!=t?{wxusername:e,wxhash:t}:{};void 0!==s&&null!=s&&""!=s&&(u.vendor=s);var c=n+"getaccts.php?changepw=1&changepw2=1&includersaprivatekeyenc=1&changeun="+(e!=a?encodeURIComponent(a):"")+"&resetrsakeys="+(o?"1":"0")+"&includeendmarker=1",d;"undefined"!=typeof g_recovery_uid&&(c+="&recovery_uid="+encodeURIComponent(g_recovery_uid)),b()({url:c,type:"POST",data:u,timeout:3e5,success:"function"==typeof i?i:null,error:"function"==typeof r?r:null})};j(function(){K(function(){u()},r)},r)}function E(e,t,a,o,i){""===a&&o();var r=f||token,s;b()({url:n+"lmiapi/one-time-password",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({masterPasswordHash:a}),headers:{"X-CSRF-TOKEN":r},success:function(n,r){if("object"==typeof n.oneTimePasswords)if(k=[],0!==n.oneTimePasswords.length){var s=[];try{for(var u=fix_username(y.newemail),c=0;c<n.oneTimePasswords.length;c++){var d=n.oneTimePasswords[c],l={},f=dec(d.encryptedOneTimePassword,e),p=AES.hex2bin(f),h=make_lp_hash(u,p),_=make_lp_key(u,p);d.oneTimePasswordHash=h,d.randomEncryptedKey=enc(AES.bin2hex(e),_),l.encryptedOneTimePassword=enc(f,t),l.randomEncryptedKey=enc(AES.bin2hex(t),_),l.oneTimePasswordHash=h,s.push(l),k.push(d)}}catch(e){return void("function"==typeof i&&i(n,r,"OTP Encryption failed"))}S(s,a,o,i)}else"function"==typeof o&&o();else"function"==typeof i&&i(n,r,"Invalid one time password response")},error:function(e,n){"function"==typeof i&&i(e,n,"GET one time passwords failed")}})}function A(e){0!==k.length?S(k,pwhash,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function S(e,t,a,o){""===t&&a();var i=JSON.stringify({oneTimePasswords:e,masterPasswordHash:t}),r=f||token,s;b()({url:n+"lmiapi/one-time-password/update",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":r},data:i,dataType:"json",success:a,error:function(e,n){"function"==typeof o&&o(e,n,"POST new one time passwords failed")}})}function O(e,t,a,o){var i=f||token,r;b()({url:n+"lmiapi/authenticator/backup",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":i},success:function(n,i){var r;try{g=n.userData;var s=dec(n.userData,e);r=enc(s,t)}catch(e){return void("function"==typeof o&&o(n,i,"Encryption failed"))}I(r,a,o)},error:function(e,n){e.status&&404==e.status?"function"==typeof a&&a():"function"==typeof o&&o(e,n,"GET new LP cloud backup failed")}})}function x(e){g?I(g,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function I(e,t,a){var o=JSON.stringify({userData:e}),i=f||token,r;b()({url:n+"lmiapi/authenticator/backup",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":i},data:o,dataType:"json",success:t,error:function(e,n){"function"==typeof a&&a(e,n,"POST new LP cloud backup failed")}})}function C(){var e=null,n=y.callback;"function"==typeof n&&n(2,!1,!1,e)}function R(){try{if(2==e){t=y.reencrypt.split("\n"),"number"==typeof g_target_key_iterations&&(h=g_target_key_iterations,"undefined"!=typeof g_key_iterations&&g_key_iterations!=g_target_key_iterations&&(y.iterationschange="1")),s=y.newkey||make_lp_key_iterations(fix_username(y.newemail),y.newpassword,h),a+=t[0]+"\n";var f=t[1];if(""!=f){var p=rsa_extract_privatekey(f,y.oldkey);""==p&&""!=y.oldkey1&&(p=rsa_extract_privatekey(f,y.oldkey1)),""==p?o="":(o=rsa_encrypt_privatekey(p,s),p=null),i=SHA256(AES.bin2hex(s).toUpperCase()),r=SHA256(o)}}if(void 0===t.length)return void y.callback(2,!1,!1,"F2 : internal error");var g,k,w=!1;try{enc(" ",s)&&(w=!0)}catch(e){}for(var m=e+3;e<t.length&&e<m;++e){var v,T=t[e].replace(/\r\n|\r|\n/g,"").split("\t");if(l=T[0],"endmarker"!=l){var P=void 0!==T.length&&T.length>=2&&"0"==T[1];if(void 0!==l.length&&l.length){var A=null;if(w)try{g=dec(l,y.oldkey),k=enc(g,s)}catch(e){A=e}if(!w||null!=A||!AES.ok(k)||0==k.length||null==g||void 0===g.length||0==g.length){if(!P){if(w)null!=(g=dec(l,s))&&void 0!==g.length&&0!=g.length||(u+="enc: "+l+" decrypted:  reencrypted to: "+k+(null==A?"":" : EXCEPTION_A!")+"\n");else{var S=void 0===s.length?"undefined":s.length;u+="encrypting <space> using m_newkey (m_newkey.length="+S+") resulted in EXCEPTION_B!\n"}c++}k=w?l:""}P||d++,a+=l+":"+k+"\n","function"==typeof y.status&&y.status(1,(e-1)/(t.length-2))}}else y.foundendmarker=!0}if(e<t.length)return void setTimeout(function(){R()},0);if(!y.foundendmarker)return void("function"==typeof y.callback&&y.callback(2,!1,!1,"D : Data download not complete"));if(void 0!==_&&_||(_=10),""!=u&&c>=d/100*_){var x={errors:u,username:y.oldemail},I;return b()({url:n+"debug.php",data:x,type:"POST",timeout:6e5,success:function(e){},error:function(e,n){}}),void("function"==typeof y.callback&&y.callback(3,null,null,"E : "+u))}"function"==typeof tracelog&&tracelog("Re encryption finished."),O(y.oldkey,s,function(){y.iterationschange?E(y.oldkey,s,y.oldpwhash,N,C):N()},C)}catch(e){y.callback(2,!1,!1,"F : "+e.message)}}this.hashMigration=function(e,t,a,o,i,r,s,u,c,d){if(void 0===d&&(d=""),m=!1,v=!1,w=!1,n=r,f=s,h=u,_=0,"function"!=typeof c&&(c=function(){}),e!==o){var l=function(e,n,t,a){0===e?c(!0):c(!1,a)},p,g;P(a,t,a,!1,function(n){var r;"string"==typeof n?"usernametaken"!=n?(y={oldkey:e,oldkey1:d,oldpwhash:t,oldemail:a,newemail:a,newkey:o,newpwhash:i,callback:l,reencrypt:n,foundendmarker:!1,iterationschange:"1",hashmigration:"1"},setTimeout(function(){R()},0)):c(!1,"Username taken or deleted during hash migration"):c(!1,"Invalid response")},function(){c(!1,"Error retrieving accounts data during hash migration")})}else c(!1,"Hash migration already happened? Maybe stale extension data")},this.recoveryChangePassword=function(e,n,t,a,o,i,r,s){w=!0,m=!1,v=!1;var u="",c,d=!1;T(e,n,t,t,a,!1,o,"",i,null,r,s)},this.superAdminPasswordReset=function(e,n,t,a,o,i,r,s){w=!1,m=!0,v=!1;var u="",c,d="",l=!1;T(e,"",n,t,a,!1,o,"",i,null,r,s)},this.setInitialPassword=function(e,n,t,a,o,i,r,s){w=!1,m=!1,v=!0;var u="",c,d="",l=!1;T(e,"",n,t,a,!1,o,"",i,null,r,s)},this.changepw=function(e,n,t,a,o,i,r,s,u,c,d,l,f,p,y){w=!1,m=!1,v=!1,T(e,n,t,a,o,i,r,s,u,c,d,l,f,p,y)};var j=function(e,t){var a;Array.isArray(window.g_su_pubkeys)&&Array.isArray(window.g_su_uids)?e():b()({url:n+"lmiapi/users/me/publicsharingkeys",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":f},success:function(n){window.g_su_pubkeys=n.map(function(e){return e.publicSharingKey}),window.g_su_uids=n.map(function(e){return e.userId}),e&&e()},error:function(e,n){C(),t&&t(e,n,"Cannot GET sharing keys")}})},K=function(e,t){var a;Array.isArray(window.g_lu_pubkeys)&&Array.isArray(window.g_lu_uids)?e():(window.g_lu_pubkeys=[],window.g_lu_uids=[],b()({url:n+"lmiapi/emergency-access/sharees",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":f},success:function(n){n.forEach(function(e){window.g_lu_pubkeys.push(e.publicSharingKey),window.g_lu_uids.push(e.userId)}),e&&e()},error:function(n,a){404!==n.status?(C(),t&&t(n,a,"Request for emergency access keys failed")):e()}}))};function N(){"function"==typeof tracelog&&tracelog("Update data to server.");var l=y.newpwhash||make_lp_hash_iterations(s,y.newpassword,h),_={reencrypt:a,newprivatekeyenc:o,newuserkeyhexhash:i,newprivatekeyenchexhash:r,newpasswordhash:l,pwupdate:"1",email:y.newemail,token:f,encrypted_username:encecb(y.newemail,s),origusername:y.oldemail,key_iterations:h};if(y.iterationschange&&(_.iterationschange=y.iterationschange),y.hashmigration&&(_.hashmigration=y.hashmigration,_.ks=!0),w&&(_.is_recovery="1"),m&&(_.superAdminReset="1"),v&&(_.setInitialPassword="1"),void 0!==y.oldpwhash&&null!=y.oldpwhash&&""!=y.oldpwhash&&(_.wxusername=y.oldemail,_.wxhash=y.oldpwhash),void 0!==y.ks&&y.ks&&(_.ks="true"),void 0!==p&&null!=p&&(_.password_hint=p),"undefined"!=typeof g_su_pubkeys&&null!=g_su_pubkeys&&g_su_pubkeys.length){for(var g=!1,k=0,T=0;T<g_su_pubkeys.length;T++)if(""!=g_su_pubkeys[T]){var P=new RSAKey;parse_public_key(P,g_su_pubkeys[T])&&(_["sukey"+k]=P.encrypt(AES.bin2hex(s)),_["suuid"+k]=g_su_uids[T],g=!0,k++)}if(_.sukeycnt=k,0==g&&"function"==typeof y.callback)return void y.callback(2,!1,!1,"G : Please tell your administrator that all users marked as Administrators must log into a browser extension once in order to properly setup account recovery.")}if("undefined"!=typeof g_lu_pubkeys&&null!=g_lu_pubkeys){var k=0;g_lu_pubkeys.forEach(function(e,n){if(e){var t=new RSAKey;parse_public_key(t,e)&&(_["lukey"+k]=t.encrypt(AES.bin2hex(s)),_["luuid"+k]=g_lu_uids[n],k++)}}),_.lukeycnt=k}"undefined"!=typeof g_recovery_uid&&(_.recovery_uid=g_recovery_uid),"undefined"!=typeof g_changeiterations&&1==g_changeiterations&&(_.iterationschange="1"),"undefined"!=typeof g_sapr_pwd&&"undefined"!=typeof g_sapr_newpwd&&(_.to_be_federated=1,_.fed_keyALP=g_sapr_keyALP,_.fed_keyLP=g_sapr_keyLP,_.fed_keyLPCheckHash=g_sapr_keyLPCheckHash,_.fed_fragmentId=g_sapr_fragmentId,_.fed_pwdlastset=g_sapr_lastPwdSet),"undefined"!=typeof g_oid_fragmentId&&(_.fedOId_fragmentId=g_oid_fragmentId);var E=y.callback,S=s,O=y.newemail,I=y.status,C;y=new Array,t=new Array,a="",e=2,s="",u="",c=0,d=0,"function"==typeof I&&I(2,0),b()({url:n+"settings.php",data:_,type:"POST",timeout:6e5,success:function(e){"function"==typeof I&&I(2,1),-1!=e.indexOf("pwchangeok")?"function"==typeof E&&E(0,S,O):e.indexOf("reusepass")>=0?x(function(){A(function(){E(2,!1,!1,"H : "+e.split("\n")[1])})}):0==e.indexOf("error\n")?x(function(){A(function(){E(2,!1,!1,e.split("\n")[1])})}):x(function(){A(function(){E(2,!1,!1,"I : An error occured")})})},error:function(e,n,t){x(function(){A(function(){"function"==typeof E&&E(2,!1,!1,"J : "+n+" suberror="+t)})})}})}}
//# sourceMappingURL=sourcemaps/pwchanger.js.map
